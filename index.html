<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>gitshame - your GitHub year, roasted.</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Space+Grotesk:wght@400;500;700&family=JetBrains+Mono:wght@400;700&family=Bebas+Neue&family=Orbitron:wght@400;700&family=Bungee:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
      :root {
        --bg-dark: #0d1117;
        --bg-card: rgba(22, 27, 34, 0.95);
        --accent-red: #ff3b3b;
        --accent-orange: #ff6b35;
        --accent-purple: #a855f7;
        --accent-cyan: #22d3ee;
        --accent-green: #39d353;
        --accent-yellow: #f0c000;
        --text-primary: #ffffff;
        --text-muted: #8b949e;
        --border-color: #30363d;
        --font-display: "Bungee", "Bebas Neue", sans-serif;
        --font-main: "Inter", sans-serif;
        --font-heading: "Orbitron", sans-serif;
        --font-value: "Bebas Neue", sans-serif;
        --font-mono: "JetBrains Mono", monospace;
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        background: var(--bg-dark);
        color: var(--text-primary);
        font-family: var(--font-main);
        min-height: 100vh;
      }

      /* ANIMATED BG */
      .bg-gradient {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: radial-gradient(
            ellipse at top left,
            rgba(168, 85, 247, 0.15) 0%,
            transparent 50%
          ),
          radial-gradient(
            ellipse at bottom right,
            rgba(255, 59, 59, 0.1) 0%,
            transparent 50%
          );
        z-index: 0;
      }

      /* CODE RAIN */
      .code-rain {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        overflow: hidden;
        z-index: 0;
        pointer-events: none;
        opacity: 0.08;
      }

      .code-column {
        position: absolute;
        top: -100%;
        font-family: var(--font-mono);
        font-size: 12px;
        color: var(--accent-green);
        writing-mode: vertical-rl;
        text-orientation: mixed;
        animation: code-fall linear infinite;
        text-shadow: 0 0 10px var(--accent-green);
      }

      @keyframes code-fall {
        0% {
          transform: translateY(-100%);
          opacity: 1;
        }

        100% {
          transform: translateY(200vh);
          opacity: 0;
        }
      }

      /* FLOATING PARTICLES */
      .particles {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 0;
        pointer-events: none;
      }

      .particle {
        position: absolute;
        width: 4px;
        height: 4px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.3);
        animation: float 20s linear infinite;
      }

      @keyframes float {
        0% {
          transform: translateY(100vh) rotate(0deg);
          opacity: 0;
        }

        10% {
          opacity: 1;
        }

        90% {
          opacity: 1;
        }

        100% {
          transform: translateY(-100vh) rotate(720deg);
          opacity: 0;
        }
      }

      /* GRID OVERLAY */
      .grid-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-image: linear-gradient(
            rgba(255, 255, 255, 0.02) 1px,
            transparent 1px
          ),
          linear-gradient(90deg, rgba(255, 255, 255, 0.02) 1px, transparent 1px);
        background-size: 50px 50px;
        z-index: 0;
        pointer-events: none;
      }

      #app {
        position: relative;
        z-index: 1;
        min-height: 100vh;
      }

      /* HERO */
      .hero {
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        padding: 40px 20px;
        text-align: center;
      }

      .logo {
        font-family: var(--font-display);
        font-size: clamp(4rem, 15vw, 10rem);
        letter-spacing: 6px;
        background: linear-gradient(180deg, #fff 0%, var(--accent-red) 100%);
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
        filter: drop-shadow(0 0 40px rgba(255, 59, 59, 0.4));
      }

      .tagline {
        font-size: 1.2rem;
        color: var(--text-muted);
        margin-top: 10px;
      }

      .tagline .red {
        color: var(--accent-red);
        font-weight: 700;
      }

      .input-box {
        background: var(--bg-card);
        border: 1px solid var(--border-color);
        border-radius: 16px;
        padding: 40px;
        margin-top: 50px;
        width: 100%;
        max-width: 450px;
      }

      .input-group {
        display: flex;
        flex-direction: column;
        gap: 16px;
      }

      .input-field {
        background: rgba(0, 0, 0, 0.4);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 18px;
        font-size: 1.1rem;
        font-family: var(--font-mono);
        color: var(--accent-green);
        text-align: center;
      }

      .input-field:focus {
        outline: none;
        border-color: var(--accent-red);
      }

      .input-field::placeholder {
        color: #444;
      }

      .btn-shame {
        background: linear-gradient(
          135deg,
          var(--accent-red),
          var(--accent-orange)
        );
        border: none;
        border-radius: 12px;
        padding: 18px 28px;
        font-size: 1rem;
        font-weight: 700;
        font-family: var(--font-heading);
        letter-spacing: 0.4px;
        text-transform: none;
        color: #fff;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        position: relative;
        overflow: hidden;
      }

      .btn-shame::before {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.2),
          transparent
        );
        animation: shimmer 2s infinite;
      }

      @keyframes shimmer {
        0% {
          left: -100%;
        }

        100% {
          left: 100%;
        }
      }

      .btn-shame:hover {
        transform: translateY(-3px);
        box-shadow: 0 15px 40px rgba(255, 59, 59, 0.5);
      }

      .btn-shame svg {
        width: 18px;
        height: 18px;
        stroke: currentColor;
        fill: none;
        stroke-width: 2;
      }

      /* LOADING */
      .loading-screen {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: var(--bg-dark);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 100;
      }

      .loading-screen.hidden {
        display: none;
      }

      .loader {
        font-family: var(--font-display);
        font-size: 3rem;
        color: var(--accent-red);
        animation: pulse 1s ease-in-out infinite;
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }

        50% {
          opacity: 0.5;
        }
      }

      .loading-text {
        font-family: var(--font-mono);
        color: var(--text-muted);
        margin-top: 20px;
      }

      /* RESULTS SCREEN - CARD GRID LAYOUT */
      .results-screen {
        min-height: 100vh;
        padding: 30px 20px;
        max-width: 800px;
        margin: 0 auto;
      }

      .results-screen.hidden {
        display: none;
      }

      /* PROFILE HEADER */
      .profile-header {
        display: flex;
        align-items: center;
        gap: 20px;
        margin-bottom: 30px;
      }

      .avatar {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        border: 3px solid var(--accent-purple);
      }

      .profile-info .username {
        font-family: var(--font-mono);
        font-size: 1.5rem;
        font-weight: 700;
      }

      .profile-info .year {
        color: var(--accent-green);
        font-size: 1rem;
      }

      /* HEATMAP CARD */
      .heatmap-card {
        background: var(--bg-card);
        border: 1px solid var(--border-color);
        border-radius: 16px;
        padding: 24px;
        margin-bottom: 20px;
      }

      .heatmap-grid {
        display: grid;
        grid-template-columns: repeat(53, 1fr);
        gap: 3px;
        margin-bottom: 12px;
      }

      .heat-cell {
        aspect-ratio: 1;
        border-radius: 2px;
        background: #161b22;
      }

      .heat-cell.l1 {
        background: #0e4429;
      }

      .heat-cell.l2 {
        background: #006d32;
      }

      .heat-cell.l3 {
        background: #26a641;
      }

      .heat-cell.l4 {
        background: #39d353;
      }

      .heatmap-label {
        font-size: 0.85rem;
        color: var(--text-muted);
      }

      /* STATS GRID */
      .stats-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 16px;
        margin-bottom: 20px;
      }

      .stat-card {
        background: var(--bg-card);
        border: 1px solid var(--border-color);
        border-radius: 16px;
        padding: 24px;
        position: relative;
        overflow: hidden;
      }

      .stat-card::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 4px;
      }

      .stat-card.red::before {
        background: linear-gradient(
          90deg,
          var(--accent-red),
          var(--accent-orange)
        );
      }

      .stat-card.purple::before {
        background: linear-gradient(90deg, var(--accent-purple), #ec4899);
      }

      .stat-card.green::before {
        background: linear-gradient(
          90deg,
          var(--accent-green),
          var(--accent-cyan)
        );
      }

      .stat-card.yellow::before {
        background: linear-gradient(
          90deg,
          var(--accent-yellow),
          var(--accent-orange)
        );
      }

      .stat-card.cyan::before {
        background: linear-gradient(
          90deg,
          var(--accent-cyan),
          var(--accent-purple)
        );
      }

      .stat-card.orange::before {
        background: linear-gradient(
          90deg,
          var(--accent-orange),
          var(--accent-red)
        );
      }

      .stat-card .icon {
        margin-bottom: 12px;
        color: var(--text-muted);
      }

      .stat-card .icon svg {
        width: 24px;
        height: 24px;
        stroke: currentColor;
        fill: none;
        stroke-width: 1.5;
      }

      .stat-card .label {
        font-size: 0.75rem;
        color: var(--text-muted);
        margin-bottom: 8px;
        text-transform: none;
        letter-spacing: 0.4px;
      }

      .stat-card .value {
        font-family: var(--font-display);
        font-size: 2.2rem;
        letter-spacing: 0.4px;
        line-height: 1;
      }

      .stat-card .roast {
        font-size: 0.7rem;
        color: var(--accent-red);
        margin-top: 12px;
        font-style: italic;
        opacity: 0.9;
      }

      /* VERDICT CARD */
      .verdict-card {
        background: linear-gradient(
          135deg,
          rgba(255, 59, 59, 0.15),
          rgba(168, 85, 247, 0.15)
        );
        border: 2px solid var(--accent-red);
        border-radius: 20px;
        padding: 40px 30px;
        text-align: center;
        margin-bottom: 20px;
        position: relative;
        overflow: hidden;
      }

      .verdict-card::before {
        content: "";
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: conic-gradient(
          from 0deg,
          transparent,
          rgba(255, 59, 59, 0.1),
          transparent
        );
        animation: rotate 4s linear infinite;
      }

      @keyframes rotate {
        100% {
          transform: rotate(360deg);
        }
      }

      .verdict-title {
        font-family: var(--font-heading);
        font-size: 0.9rem;
        font-weight: 600;
        color: var(--accent-red);
        letter-spacing: 0.6px;
        text-transform: none;
        margin-bottom: 20px;
        position: relative;
        z-index: 1;
      }

      .verdict-text {
        font-family: var(--font-display);
        font-size: 2rem;
        letter-spacing: 0.6px;
        line-height: 1.3;
        position: relative;
        z-index: 1;
        background: linear-gradient(135deg, #fff, #ccc);
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
      }

      .btn-download {
        position: fixed;
        bottom: 30px;
        right: 30px;
        width: 50px;
        height: 50px;
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.15);
        border-radius: 50%;
        color: #fff;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 100;
      }

      .btn-download svg {
        width: 20px;
        height: 20px;
        stroke: currentColor;
        fill: none;
        stroke-width: 2;
      }

      .btn-download:hover {
        background: rgba(255, 255, 255, 0.2);
        transform: scale(1.05);
      }

      .btn-download:disabled {
        opacity: 0.5;
        cursor: wait;
      }

      .btn-download.success {
        background: rgba(57, 211, 83, 0.2);
        border-color: rgba(57, 211, 83, 0.4);
      }

      .btn-download.error {
        background: rgba(255, 59, 59, 0.2);
        border-color: rgba(255, 59, 59, 0.4);
      }

      .btn-download .spin {
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        from {
          transform: rotate(0deg);
        }

        to {
          transform: rotate(360deg);
        }
      }

      /* RESTART BUTTON */
      .btn-restart {
        position: fixed;
        top: 30px;
        right: 30px;
        width: 44px;
        height: 44px;
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.15);
        border-radius: 50%;
        color: #fff;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 100;
      }

      .btn-restart svg {
        width: 18px;
        height: 18px;
        stroke: currentColor;
        fill: none;
        stroke-width: 2;
      }

      .btn-restart:hover {
        background: rgba(255, 255, 255, 0.2);
        transform: rotate(180deg);
      }

      /* SVG ICONS */
      .icon-svg {
        width: 20px;
        height: 20px;
        stroke: currentColor;
        fill: none;
        stroke-width: 2;
        vertical-align: middle;
        margin-right: 8px;
      }

      .footer {
        display: flex;
        flex-direction: column; /* stack lines */
        align-items: center;
        justify-content: center;
        gap: 6px;
        margin-top: 30px;
        font-size: 0.9rem;
        color: var(--text-muted);
      }

      .footer .footer-line {
        display: block;
      }

      .footer .made-by {
        font-family: var(--font-mono);
        color: var(--text-muted);
        display: inline-flex;
        align-items: center;
        gap: 0;
      }

      .footer .code-sigil {
        font-family: var(--font-mono);
        background: rgba(255, 255, 255, 0.02);
        padding: 2px 6px;
        border-radius: 6px;
        color: var(--text-muted);
        font-weight: 600;
        letter-spacing: 0.5px;
      }

      .open-source-link {
        color: #9fd3ff; /* light blue matching screenshot */
        display: inline-flex;
        align-items: center;
        text-decoration: none;
        padding: 6px;
        border-radius: 8px;
        transition: opacity 0.18s ease;
      }

      .open-source-link:hover {
        opacity: 0.9;
        transform: translateY(-1px);
      }

      .open-source-link svg {
        width: 18px;
        height: 18px;
        stroke: currentColor;
        fill: currentColor;
        stroke-width: 1.2;
        stroke-linecap: round;
        stroke-linejoin: round;
      }
      .open-source-link img.open-source-icon {
        width: 18px;
        height: 18px;
        display: inline-block;
        vertical-align: middle;
        margin-right: 8px;
      }
      .open-source-link .open-source-text {
        margin-left: 8px;
        font-family: var(--font-mono);
        color: inherit;
        font-size: 0.95rem;
        font-weight: 500;
      }

      /* Ensure open-source badge does not appear in exported images */
      #exportContainer .open-source-link,
      .png-export-container .open-source-link,
      .export-layout .open-source-link {
        display: none !important;
      }
      #exportContainer .made-by,
      .png-export-container .made-by,
      .export-layout .made-by {
        display: none !important;
      }

      /* Hero footer style for visibility on the homepage */
      .hero .hero-footer {
        margin-top: 24px;
      }
      .hero .hero-footer .open-source-text {
        font-size: 1rem;
      }

      /* EXPORT LAYOUT */
      #exportContainer {
        position: fixed;
        left: -9999px;
        top: 0;
        width: 1080px;
        height: 1920px;
      }

      .export-layout {
        width: 1080px;
        height: 1920px;
        background: linear-gradient(180deg, #0d1117 0%, #161b22 100%);
        padding: 80px 50px;
        font-family: "Inter", sans-serif;
        color: #fff;
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      .export-header {
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        margin-bottom: 50px;
      }

      .export-avatar {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        border: 4px solid #a855f7;
        margin-bottom: 20px;
      }

      .export-username {
        font-family: var(--font-main);
        font-size: 3rem;
        letter-spacing: 0.6px;
        font-weight: 700;
      }

      .export-year {
        color: #39d353;
        font-size: 1.2rem;
        margin-top: 8px;
        letter-spacing: 0.8px;
      }

      .export-heatmap {
        width: 100%;
        background: #161b22;
        border: 1px solid #30363d;
        border-radius: 16px;
        padding: 30px;
        margin-bottom: 30px;
      }

      .export-heatmap-grid {
        display: grid;
        grid-template-columns: repeat(53, 1fr);
        gap: 3px;
        margin-bottom: 15px;
      }

      .export-heat-cell {
        aspect-ratio: 1;
        border-radius: 2px;
        background: #21262d;
      }

      .export-heat-cell.l1 {
        background: #0e4429;
      }

      .export-heat-cell.l2 {
        background: #006d32;
      }

      .export-heat-cell.l3 {
        background: #26a641;
      }

      .export-heat-cell.l4 {
        background: #39d353;
      }

      .export-heatmap-label {
        font-size: 1.2rem;
        color: #8b949e;
        text-align: center;
      }

      .export-stats-grid {
        width: 100%;
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 20px;
        flex: 1;
      }

      .export-stat-card {
        background: #161b22;
        border: 1px solid #30363d;
        border-radius: 16px;
        padding: 35px 30px;
        position: relative;
        text-align: center;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
      }

      .export-stat-card::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        border-radius: 16px 16px 0 0;
      }

      .export-stat-card.red::before {
        background: linear-gradient(90deg, #ff3b3b, #ff6b35);
      }

      .export-stat-card.purple::before {
        background: linear-gradient(90deg, #a855f7, #ec4899);
      }

      .export-stat-card.green::before {
        background: linear-gradient(90deg, #39d353, #22d3ee);
      }

      .export-stat-card.yellow::before {
        background: linear-gradient(90deg, #f0c000, #ff6b35);
      }

      .export-stat-card.cyan::before {
        background: linear-gradient(90deg, #22d3ee, #a855f7);
      }

      .export-stat-card.orange::before {
        background: linear-gradient(90deg, #ff6b35, #ff3b3b);
      }

      .export-stat-card .label {
        font-size: 0.9rem;
        font-weight: 600;
        color: #8b949e;
        letter-spacing: 0.4px;
        text-transform: none;
        margin-bottom: 12px;
      }

      .export-stat-card .value {
        font-family: var(--font-value);
        font-size: 4.5rem;
        letter-spacing: 0.4px;
        color: #fff;
        line-height: 1;
      }

      .export-stat-card .roast {
        font-size: 0.9rem;
        color: #ff3b3b;
        margin-top: 15px;
        font-style: italic;
        line-height: 1.3;
      }

      .export-footer {
        text-align: center;
        font-size: 1.2rem;
        font-weight: 600;
        color: #30363d;
        letter-spacing: 10px;
        margin-top: 30px;
      }

      .hidden {
        display: none !important;
      }
    </style>
  </head>

  <body>
    <div class="bg-gradient"></div>
    <div class="grid-overlay"></div>
    <div class="code-rain" id="codeRain"></div>
    <div class="particles" id="particles"></div>

    <div id="app">
      <!-- HERO -->
      <main class="hero" id="heroSection">
        <h1 class="logo">
          <a href="/" aria-label="gitshame homepage" class="logo-link">
            <img src="assets/gitshame.png" alt="gitshame" width="400" />
          </a>

          <!-- Keep the textual brand for screen readers -->
        </h1>
        <p class="tagline">
          Your year in code. <span class="red">Brutally roasted.</span>
        </p>
        <div class="input-box">
          <div class="input-group">
            <input
              type="text"
              class="input-field"
              id="usernameInput"
              placeholder="github_username"
              autocomplete="off"
            />
            <button class="btn-shame" id="roastBtn">
              Let's see what I did in 2025?
            </button>
          </div>
        </div>
        <div class="hero-footer footer" aria-hidden="false">
          <div class="footer-line">
            <span class="made-by"
              ><span class="code-sigil">&lt;/&gt;</span>nahinio made this. He’s
              not proud</span
            >
          </div>
          <div class="footer-line">
            <a
              class="open-source-link"
              href="https://github.com/nahinio/gitShame"
              target="_blank"
              rel="noopener noreferrer"
              aria-label="GitShame repository on GitHub"
            >
              <img
                src="assets/gitwhite.png"
                alt="GitHub"
                class="open-source-icon"
              />
              <span class="open-source-text">Open Source</span>
            </a>
          </div>
        </div>
      </main>
    </div>

    <!-- LOADING -->
    <div class="loading-screen hidden" id="loadingScreen">
      <div class="loader">Analyzing...</div>
      <p class="loading-text" id="loadingText">Fetching your sins...</p>
    </div>

    <!-- RESULTS -->
    <div class="results-screen hidden" id="resultsScreen">
      <button class="btn-restart" id="restartBtn" title="Start Over">
        <svg viewBox="0 0 24 24">
          <path d="M1 4v6h6M23 20v-6h-6" />
          <path
            d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"
          />
        </svg>
      </button>
      <div class="profile-header" id="profileHeader"></div>
      <div class="heatmap-card" id="heatmapCard"></div>
      <div class="stats-grid" id="statsGrid"></div>
      <div class="verdict-card" id="verdictCard"></div>
      <button class="btn-download" id="downloadBtn" title="Download Story">
        <svg viewBox="0 0 24 24">
          <path
            d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3"
          />
        </svg>
      </button>
      <footer class="footer" role="contentinfo">
        <div class="footer-line">
          <span class="made-by"
            ><span class="code-sigil">&lt;/&gt;</span>nahinio made this. He’s
            not proud</span
          >
        </div>
        <div class="footer-line">
          <a
            class="open-source-link"
            href="https://github.com/nahinio/gitshame"
            target="_blank"
            rel="noopener noreferrer"
            aria-label="GitShame repository on GitHub"
          >
            <img
              src="assets/gitwhite.png"
              alt="GitHub"
              class="open-source-icon"
            />
            <span class="open-source-text">Open Source</span>
          </a>
        </div>
      </footer>
    </div>

    <!-- EXPORT -->
    <div id="exportContainer"></div>

    <script>
      const CONFIG = {
        apiBase: "https://api.github.com",
        repoUrl: "https://github.com/nahinio/gitshame",
      };

      class GitHubFetcher {
        constructor(username) {
          this.username = username;
          this.userData = null;
          this.contributions = null;
          this.heatmapData = [];
          this.repos = [];
          this.events = [];
        }

        async fetchAll() {
          try {
            this.userData = await this._fetch(`/users/${this.username}`);

            const contribRes = await fetch(
              `https://github-contributions-api.jogruber.de/v4/${this.username}?y=last`
            );
            if (contribRes.ok) {
              this.contributions = await contribRes.json();
              if (this.contributions.contributions) {
                this.heatmapData = this.contributions.contributions;
              }
            }

            try {
              const p1 = await this._fetch(
                `/users/${this.username}/events?per_page=100&page=1`
              );
              this.events = p1 || [];
            } catch (e) {
              this.events = [];
            }

            this.repos = await this._fetch(
              `/users/${this.username}/repos?sort=updated&per_page=100`
            );
            return { success: true };
          } catch (e) {
            if (e.status === 404)
              return { success: false, error: "User not found" };
            if (e.status === 403)
              return { success: false, error: "Rate limited" };
            return { success: false, error: "Network error" };
          }
        }

        async _fetch(endpoint) {
          const res = await fetch(`${CONFIG.apiBase}${endpoint}`);
          if (!res.ok) {
            const err = new Error();
            err.status = res.status;
            throw err;
          }
          return res.json();
        }
      }

      class StatsEngine {
        constructor(data) {
          this.data = data;
        }

        process() {
          const s = {
            totalContributions: 0,
            longestStreak: 0,
            currentStreak: 0,
            totalRepos: 0,
            totalStars: 0,
            topLanguage: "None",
            mostActiveDay: "Unknown",
            mostActiveMonth: "Unknown",
            worstCommitMsg: "fix",
            heatmapData: [],
            powerLevel: "Newbie",
          };

          if (this.data.contributions?.total) {
            const t = this.data.contributions.total;
            s.totalContributions =
              typeof t === "object"
                ? Object.values(t).reduce((a, b) => a + b, 0)
                : t || 0;
          }

          const dayNames = [
            "Sunday",
            "Monday",
            "Tuesday",
            "Wednesday",
            "Thursday",
            "Friday",
            "Saturday",
          ];
          const monthNames = [
            "January",
            "February",
            "March",
            "April",
            "May",
            "June",
            "July",
            "August",
            "September",
            "October",
            "November",
            "December",
          ];

          if (this.data.heatmapData?.length) {
            s.heatmapData = this.data.heatmapData;
            let streak = 0,
              maxStreak = 0;
            const days = [...this.data.heatmapData].sort(
              (a, b) => new Date(b.date) - new Date(a.date)
            );

            for (const d of days) {
              if (d.count > 0) s.currentStreak++;
              else break;
            }
            for (const d of this.data.heatmapData) {
              if (d.count > 0) {
                streak++;
                maxStreak = Math.max(maxStreak, streak);
              } else streak = 0;
            }
            s.longestStreak = maxStreak;

            const dayTotals = [0, 0, 0, 0, 0, 0, 0];
            const monthTotals = Array(12).fill(0);
            this.data.heatmapData.forEach((d) => {
              const date = new Date(d.date);
              dayTotals[date.getDay()] += d.count;
              monthTotals[date.getMonth()] += d.count;
            });
            s.mostActiveDay =
              dayNames[dayTotals.indexOf(Math.max(...dayTotals))];
            s.mostActiveMonth =
              monthNames[monthTotals.indexOf(Math.max(...monthTotals))];
          }

          if (this.data.repos?.length) {
            s.totalRepos = this.data.repos.length;
            s.totalStars = this.data.repos.reduce(
              (sum, r) => sum + (r.stargazers_count || 0),
              0
            );
            const langs = {};
            this.data.repos.forEach((r) => {
              if (r.language) langs[r.language] = (langs[r.language] || 0) + 1;
            });
            const sorted = Object.entries(langs).sort((a, b) => b[1] - a[1]);
            s.topLanguage = sorted[0] ? sorted[0][0] : "None";
          }

          const msgs = [];
          this.data.events?.forEach((e) => {
            if (e.type === "PushEvent" && e.payload.commits) {
              e.payload.commits.forEach((c) => msgs.push(c.message));
            }
          });
          const bad = msgs.filter(
            (m) =>
              m.length < 20 ||
              /fix|wip|test|temp|oops|update|minor|typo|asdf/i.test(m)
          );
          s.worstCommitMsg = bad.length
            ? bad[Math.floor(Math.random() * bad.length)]
            : msgs[0] || "fix";

          // Power Level
          const c = s.totalContributions;
          s.powerLevel =
            c < 100
              ? "Ghost Tier"
              : c < 300
              ? "Casual"
              : c < 700
              ? "Regular"
              : c < 1500
              ? "Warrior"
              : c < 3000
              ? "Elite"
              : "Machine God";

          return s;
        }
      }

      class RoastGenerator {
        constructor(stats) {
          this.s = stats;
        }

        getContribRoast() {
          const c = this.s.totalContributions;
          if (c < 50) return "Is this GitHub or a graveyard?";
          if (c < 200) return "Barely a pulse on your contribution graph.";
          if (c < 500) return "Participation trophy vibes.";
          if (c < 1000) return "You showed up. Barely impressive.";
          if (c < 2000) return "Your keyboard is crying for help.";
          return "Touched grass lately? Didn't think so.";
        }

        getStreakRoast() {
          const s = this.s.longestStreak;
          if (s < 7) return "Commitment issues much?";
          if (s < 30) return "Almost formed a habit. Almost.";
          if (s < 100) return "Obsessive or just no social life?";
          return "Seek professional help immediately.";
        }

        getStarsRoast() {
          const s = this.s.totalStars;
          if (s < 10) return "Even your mom wouldn't star this.";
          if (s < 50) return "Maybe buy some fake stars?";
          if (s < 200) return "Mildly popular. Among bots.";
          return "Okay, I'm actually impressed.";
        }

        getDayRoast() {
          const d = this.s.mostActiveDay;
          if (d === "Saturday" || d === "Sunday")
            return "No weekend plans, I see.";
          if (d === "Friday") return "TGIF? More like TGIC (Thank God I Code).";
          return "At least you're not coding on weekends.";
        }

        getLanguageRoast() {
          const l = this.s.topLanguage;
          if (l === "JavaScript") return "Another JS warrior. How original.";
          if (l === "Python") return "Let me guess, AI and data science?";
          if (l === "TypeScript")
            return "JS but for people who need handholding.";
          if (l === "Java") return "Enterprise much? Boomer.";
          if (l === "C++") return "You hate yourself and it shows.";
          if (l === "Rust") return "We get it, you're better than everyone.";
          return "Interesting choice. Wrong, but interesting.";
        }

        getPowerRoast() {
          const p = this.s.powerLevel;
          if (p === "Ghost Tier") return "Did you even code this year?";
          if (p === "Casual") return "Weekend warrior at best.";
          if (p === "Regular") return "Average. Painfully average.";
          if (p === "Warrior") return "Respectable. Your team tolerates you.";
          if (p === "Elite") return "Dangerously productive. Seek balance.";
          return "You're not human. You're an algorithm.";
        }

        getVerdict() {
          const c = this.s.totalContributions;
          if (c < 100)
            return "The Ghost — Did you even turn on your computer this year?";
          if (c < 300)
            return "The Lurker — Present but not productive. Classic.";
          if (c < 700) return "The Average — You exist. That's... something.";
          if (c < 1500) return "The Grinder — You shipped code. Respect.";
          if (c < 3000) return "The Demon — Your IDE is your best friend.";
          return "The Machine — Are you even human? Terrifying.";
        }
      }

      class App {
        constructor() {
          this.els = {
            hero: document.getElementById("heroSection"),
            input: document.getElementById("usernameInput"),
            btn: document.getElementById("roastBtn"),
            loading: document.getElementById("loadingScreen"),
            loadingText: document.getElementById("loadingText"),
            results: document.getElementById("resultsScreen"),
            profileHeader: document.getElementById("profileHeader"),
            heatmapCard: document.getElementById("heatmapCard"),
            statsGrid: document.getElementById("statsGrid"),
            verdictCard: document.getElementById("verdictCard"),
            downloadBtn: document.getElementById("downloadBtn"),
            restartBtn: document.getElementById("restartBtn"),
            export: document.getElementById("exportContainer"),
          };
          this.state = { stats: null, user: null, roast: null };
          this.loadingMsgs = [
            "Fetching your sins...",
            "Counting failures...",
            "Preparing roast...",
            "Loading destruction...",
          ];
          this.init();
        }

        init() {
          this.els.btn.addEventListener("click", () => this.start());
          this.els.input.addEventListener("keypress", (e) => {
            if (e.key === "Enter") this.start();
          });
          this.els.downloadBtn.addEventListener("click", () => this.download());
          this.els.restartBtn.addEventListener("click", () => this.restart());
        }

        restart() {
          this.els.results.classList.add("hidden");
          document.getElementById("app").classList.remove("hidden");
          this.els.input.value = "";
          this.els.input.focus();
        }

        async start() {
          const username = this.els.input.value.trim();
          if (!username) return;

          this.showLoading();

          const fetcher = new GitHubFetcher(username);
          const result = await fetcher.fetchAll();

          if (!result.success) {
            alert(result.error);
            this.hideLoading();
            return;
          }

          this.state.stats = new StatsEngine({
            contributions: fetcher.contributions,
            heatmapData: fetcher.heatmapData,
            repos: fetcher.repos,
            events: fetcher.events,
          }).process();

          this.state.user = fetcher.userData;
          this.state.roast = new RoastGenerator(this.state.stats);

          this.renderResults();
          this.hideLoading();
          this.showResults();
        }

        showLoading() {
          document.getElementById("app").classList.add("hidden");
          this.els.loading.classList.remove("hidden");
          let i = 0;
          this.loadingInterval = setInterval(() => {
            this.els.loadingText.textContent =
              this.loadingMsgs[i++ % this.loadingMsgs.length];
          }, 800);
        }

        hideLoading() {
          clearInterval(this.loadingInterval);
          this.els.loading.classList.add("hidden");
        }

        showResults() {
          this.els.results.classList.remove("hidden");
          confetti({
            particleCount: 150,
            spread: 100,
            origin: { y: 0.6 },
            colors: ["#ff3b3b", "#a855f7", "#22d3ee"],
          });
        }

        renderHeatmap(data, cellClass = "heat-cell") {
          let html = "";
          const last371 = data.slice(-371);
          for (let i = 0; i < 371; i++) {
            const d = last371[i];
            const level = !d
              ? ""
              : d.count === 0
              ? ""
              : d.count < 3
              ? "l1"
              : d.count < 6
              ? "l2"
              : d.count < 10
              ? "l3"
              : "l4";
            html += `<div class="${cellClass} ${level}"></div>`;
          }
          return html;
        }

        renderResults() {
          const s = this.state.stats;
          const u = this.state.user;
          const r = this.state.roast;

          // Profile
          this.els.profileHeader.innerHTML = `
                    <img src="${u.avatar_url}" class="avatar" crossorigin="anonymous">
                    <div class="profile-info">
                        <div class="username">@${u.login}</div>
                        <div class="year">2025 Year in Code</div>
                    </div>
                `;

          // Heatmap
          this.els.heatmapCard.innerHTML = `
                    <div class="heatmap-grid">${this.renderHeatmap(
                      s.heatmapData
                    )}</div>
                    <div class="heatmap-label">${s.totalContributions.toLocaleString()} contributions in 2025</div>
                `;

          // Stats Grid - Using SVG icons instead of emojis
          const icons = {
            trophy:
              '<svg class="icon-svg" viewBox="0 0 24 24"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6M18 9h1.5a2.5 2.5 0 0 0 0-5H18M4 22h16M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg>',
            bolt: '<svg class="icon-svg" viewBox="0 0 24 24"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>',
            calendar:
              '<svg class="icon-svg" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><path d="M16 2v4M8 2v4M3 10h18"/></svg>',
            chart:
              '<svg class="icon-svg" viewBox="0 0 24 24"><path d="M18 20V10M12 20V4M6 20v-6"/></svg>',
            star: '<svg class="icon-svg" viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>',
            code: '<svg class="icon-svg" viewBox="0 0 24 24"><path d="M16 18l6-6-6-6M8 6l-6 6 6 6"/></svg>',
            zap: '<svg class="icon-svg" viewBox="0 0 24 24"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>',
            skull:
              '<svg class="icon-svg" viewBox="0 0 24 24"><circle cx="9" cy="12" r="1"/><circle cx="15" cy="12" r="1"/><path d="M8 20v2h8v-2M12.5 17l-.5-1-.5 1M17.4 4.6a9 9 0 0 0-10.8 0A8.1 8.1 0 0 0 4 11c0 1.5.4 2.9 1.2 4.2.5.8.8 1.8.8 2.8v1h12v-1c0-1 .3-2 .8-2.8.8-1.3 1.2-2.7 1.2-4.2 0-2.5-1-4.8-2.6-6.4z"/></svg>',
          };

          this.els.statsGrid.innerHTML = `
                    <div class="stat-card red">
                        <div class="icon">${icons.trophy}</div>
                        <div class="label">Total Contributions</div>
                        <div class="value">${s.totalContributions.toLocaleString()}</div>
                        <div class="roast">${r.getContribRoast()}</div>
                    </div>
                    <div class="stat-card purple">
                        <div class="icon">${icons.bolt}</div>
                        <div class="label">Longest Streak</div>
                        <div class="value">${s.longestStreak} days</div>
                        <div class="roast">${r.getStreakRoast()}</div>
                    </div>
                    <div class="stat-card green">
                        <div class="icon">${icons.calendar}</div>
                        <div class="label">Most Active Month</div>
                        <div class="value">${s.mostActiveMonth}</div>
                    </div>
                    <div class="stat-card yellow">
                        <div class="icon">${icons.chart}</div>
                        <div class="label">Most Active Day</div>
                        <div class="value">${s.mostActiveDay}</div>
                        <div class="roast">${r.getDayRoast()}</div>
                    </div>
                    <div class="stat-card cyan">
                        <div class="icon">${icons.star}</div>
                        <div class="label">Total Stars</div>
                        <div class="value">${s.totalStars}</div>
                        <div class="roast">${r.getStarsRoast()}</div>
                    </div>
                    <div class="stat-card orange">
                        <div class="icon">${icons.code}</div>
                        <div class="label">Top Language</div>
                        <div class="value">${s.topLanguage}</div>
                        <div class="roast">${r.getLanguageRoast()}</div>
                    </div>
                    <div class="stat-card purple" style="grid-column: span 2;">
                        <div class="icon">${icons.zap}</div>
                        <div class="label">Power Level</div>
                        <div class="value">${s.powerLevel}</div>
                        <div class="roast">${r.getPowerRoast()}</div>
                    </div>
                `;

          // Verdict
          this.els.verdictCard.innerHTML = `
                    <div class="verdict-title">Final Verdict</div>
                    <div class="verdict-text">${r.getVerdict()}</div>
                `;
        }

        async download() {
          const downloadIcon =
            '<svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3"/></svg>';
          const loadingIcon =
            '<svg viewBox="0 0 24 24" class="spin"><path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/></svg>';
          const checkIcon =
            '<svg viewBox="0 0 24 24"><path d="M20 6L9 17l-5-5"/></svg>';

          this.els.downloadBtn.innerHTML = loadingIcon;
          this.els.downloadBtn.disabled = true;

          const s = this.state.stats;
          const u = this.state.user;
          const r = this.state.roast;

          // Build export HTML with enhanced styling (no emojis)
          this.els.export.innerHTML = `
                    <div class="export-layout" id="exportLayout" style="font-family: 'Inter', sans-serif;">
                        <div class="export-header">
                            <img src="assets/gitshame.png" class="export-logo-img" alt="gitshame">
                            <img src="${
                              u.avatar_url
                            }" class="export-avatar" crossorigin="anonymous" id="exportAvatar">
                            <div>
                                <div class="export-username">@${u.login}</div>
                                <div class="export-year">2025 Year in Code</div>
                            </div>
                        </div>
                        <div class="export-heatmap">
                            <div class="export-heatmap-grid">${this.renderHeatmap(
                              s.heatmapData,
                              "export-heat-cell"
                            )}</div>
                            <div class="export-heatmap-label">${s.totalContributions.toLocaleString()} contributions in 2025</div>
                        </div>
                        <div class="export-stats-grid">
                            <div class="export-stat-card red">
                                <div class="label">TOTAL CONTRIBUTIONS</div>
                                <div class="value">${s.totalContributions.toLocaleString()}</div>
                                <div class="roast">${r.getContribRoast()}</div>
                            </div>
                            <div class="export-stat-card purple">
                                <div class="label">Longest Streak</div>
                                <div class="value">${s.longestStreak} days</div>
                                <div class="roast">${r.getStreakRoast()}</div>
                            </div>
                            <div class="export-stat-card green">
                                <div class="label">Most Active Month</div>
                                <div class="value">${s.mostActiveMonth}</div>
                            </div>
                            <div class="export-stat-card yellow">
                                <div class="label">Most Active Day</div>
                                <div class="value">${s.mostActiveDay}</div>
                                <div class="roast">${r.getDayRoast()}</div>
                            </div>
                            <div class="export-stat-card cyan">
                                <div class="label">Total Stars</div>
                                <div class="value">${s.totalStars}</div>
                                <div class="roast">${r.getStarsRoast()}</div>
                            </div>
                            <div class="export-stat-card orange">
                                <div class="label">Top Language</div>
                                <div class="value">${s.topLanguage}</div>
                                <div class="roast">${r.getLanguageRoast()}</div>
                            </div>
                        </div>
                        <div style="background: linear-gradient(135deg, rgba(255,59,59,0.2), rgba(168,85,247,0.2)); border: 2px solid #ff3b3b; border-radius: 24px; padding: 50px 40px; text-align: center; margin-top: 30px;">
                            <div style="font-family: 'Inter', sans-serif; font-size: 1rem; font-weight: 600; color: #ff3b3b; letter-spacing: 1px; text-transform: none; margin-bottom: 20px;">Final Verdict</div>
                            <div style="font-family: var(--font-display); font-size: 2.8rem; color: #fff; line-height: 1.2; letter-spacing: 0.4px;">${r.getVerdict()}</div>
                        </div>
                        <div class="export-footer"><img src="assets/gitshame.png" alt="gitshame" class="export-logo-img"/></div>
                    </div>
                `;

          // Wait for avatar to load
          const avatar = document.getElementById("exportAvatar");
          if (avatar && !avatar.complete) {
            await new Promise((resolve) => {
              avatar.onload = resolve;
              avatar.onerror = resolve;
              setTimeout(resolve, 3000); // Timeout fallback
            });
          }
          // Wait for export logo to load as well
          const exportLogo = document.querySelector(".export-logo-img");
          if (exportLogo && !exportLogo.complete) {
            await new Promise((resolve) => {
              exportLogo.onload = resolve;
              exportLogo.onerror = resolve;
              setTimeout(resolve, 3000);
            });
          }

          // Brief delay for fonts to render (give the head fonts a little extra time so they raster correctly)
          await new Promise((r) => setTimeout(r, 1000));

          try {
            // Temporarily move export container into view for rendering
            this.els.export.style.left = "0";
            this.els.export.style.top = "0";
            this.els.export.style.position = "fixed";
            this.els.export.style.zIndex = "-1";
            this.els.export.style.opacity = "1";

            const exportLayout = document.getElementById("exportLayout");
            // Give the browser a tick to paint before capturing (avoids artifacts)
            await new Promise((r) => setTimeout(r, 250));
            // Ensure webfonts have loaded before capturing so lowercase glyphs are available
            if (document.fonts && document.fonts.ready)
              await document.fonts.ready;
            const canvas = await html2canvas(exportLayout, {
              width: 1080,
              height: 1920,
              // Slightly increased scale for crisper text rendering on exported PNG
              scale: 1.5,
              useCORS: true,
              allowTaint: true,
              backgroundColor: "#0d1117",
              logging: false,
            });

            // Move it back
            this.els.export.style.left = "-9999px";

            const link = document.createElement("a");
            link.download = `gitshame-${u.login}.png`;
            link.href = canvas.toDataURL("image/png");
            link.click();

            confetti({ particleCount: 200, spread: 120, origin: { y: 0.5 } });
            this.els.downloadBtn.innerHTML = checkIcon;
            this.els.downloadBtn.classList.add("success");
          } catch (e) {
            console.error("Download error:", e);
            this.els.export.style.left = "-9999px";
            this.els.downloadBtn.innerHTML =
              '<svg viewBox="0 0 24 24"><path d="M18 6L6 18M6 6l12 12"/></svg>';
            this.els.downloadBtn.classList.add("error");
          }

          setTimeout(() => {
            this.els.downloadBtn.innerHTML = downloadIcon;
            this.els.downloadBtn.classList.remove("success", "error");
            this.els.downloadBtn.disabled = false;
          }, 3000);
        }
      }

      document.addEventListener("DOMContentLoaded", () => {
        new App();

        // Set all open-source links to the canonical repo URL from `CONFIG`
        (function setRepoLinks() {
          try {
            const repoUrl =
              CONFIG.repoUrl || "https://github.com/nahinio/gitshame";
            document.querySelectorAll(".open-source-link").forEach((a) => {
              a.setAttribute("href", repoUrl);
              a.setAttribute("aria-label", "GitShame repository on GitHub");
            });
          } catch (e) {
            /* no-op */
          }
        })();

        // Generate code rain
        const codeRain = document.getElementById("codeRain");
        const codeSnippets = [
          "const",
          "let",
          "function",
          "async",
          "await",
          "return",
          "if",
          "for",
          "class",
          "import",
          "export",
          "null",
          "true",
          "false",
          "git",
          "push",
          "npm",
          "run",
          "{}",
          "[]",
          "=>",
          "===",
        ];
        for (let i = 0; i < 20; i++) {
          const col = document.createElement("div");
          col.className = "code-column";
          col.style.left = Math.random() * 100 + "%";
          col.style.animationDuration = 12 + Math.random() * 15 + "s";
          col.style.animationDelay = -Math.random() * 20 + "s";
          col.textContent = Array(15)
            .fill(0)
            .map(
              () =>
                codeSnippets[Math.floor(Math.random() * codeSnippets.length)]
            )
            .join(" ");
          codeRain.appendChild(col);
        }

        // Generate particles
        const particles = document.getElementById("particles");
        for (let i = 0; i < 30; i++) {
          const p = document.createElement("div");
          p.className = "particle";
          p.style.left = Math.random() * 100 + "%";
          p.style.animationDuration = 15 + Math.random() * 20 + "s";
          p.style.animationDelay = -Math.random() * 20 + "s";
          p.style.width = 2 + Math.random() * 4 + "px";
          p.style.height = p.style.width;
          p.style.opacity = 0.2 + Math.random() * 0.3;
          particles.appendChild(p);
        }
      });
    </script>
  </body>
</html>
